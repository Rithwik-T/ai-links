<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Management App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF and html2canvas CDNs for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Custom styles for Inter font and background */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }

        /* Styles for the temporary PDF table container - kept off-screen */
        .pdf-table-container {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 1200px;
            max-width: none !important;
            padding: 20px;
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            box-sizing: border-box;
        }
        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Inter', sans-serif;
        }
        .pdf-table th, .pdf-table td {
            border: 1px solid #e2e8f0; /* Tailwind gray-200 */
            padding: 12px 15px;
            text-align: left;
            vertical-align: top;
        }
        .pdf-table th {
            background-color: #f7fafc;
            font-weight: bold;
            color: #2d3748;
        }
        .pdf-table tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .pdf-table a {
            color: #2563eb;
            text-decoration: underline;
        }
        .pdf-table .link-description {
            font-size: 0.875rem;
            color: #4a5568;
            margin-top: 4px;
        }
        .pdf-signature {
            text-align: right;
            margin-top: 30px;
            font-size: 14px;
            color: #4a5568;
            font-style: italic;
            padding-right: 20px;
        }

        /* Animation for list items on load/render */
        .link-item-enter {
            opacity: 0;
            transform: translateY(10px); /* Initial invisible and slightly moved down state */
        }
        .link-item-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 300ms ease-out, transform 300ms ease-out; /* Smooth transition to visible state */
        }
        /* Animation for deleting list items */
        .link-item-exit {
            opacity: 1;
            transform: translateY(0);
        }
        .link-item-exit-active {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 300ms ease-in, transform 300ms ease-in;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-3xl w-full bg-white p-6 rounded-xl shadow-2xl space-y-6 sm:p-8 md:p-10">
        <h2 class="text-3xl sm:text-4xl font-extrabold text-gray-900 text-center mb-6">
            ðŸ”— Shared Link Manager
        </h2>
        <div class="text-sm text-gray-600 text-center mb-4">
            <p>Viewing shared links. Your User ID: <span id="userIdDisplay" class="font-bold text-blue-600 break-all">Loading...</span></p>
        </div>

        <!-- Link Addition/Edit Form -->
        <form id="addLinkForm" class="space-y-4">
            <div>
                <label for="linkName" class="sr-only">Link Name</label>
                <input id="linkName" name="linkName" type="text" required
                       class="appearance-none block w-full px-4 py-3 border border-gray-300 rounded-lg placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                       placeholder="Link Name">
            </div>
            <div>
                <label for="linkUrl" class="sr-only">Link URL</label>
                <input id="linkUrl" name="linkUrl" type="url" required
                       class="appearance-none block w-full px-4 py-3 border border-gray-300 rounded-lg placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                       placeholder="https://example.com">
            </div>
            <div>
                <label for="linkDescription" class="sr-only">Description</label>
                <textarea id="linkDescription" name="linkDescription" rows="3"
                          class="appearance-none block w-full px-4 py-3 border border-gray-300 rounded-lg placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                          placeholder="Short description (optional)"></textarea>
            </div>
            <div>
                <label for="linkCategory" class="sr-only">Category</label>
                <input id="linkCategory" name="linkCategory" type="text"
                       class="appearance-none block w-full px-4 py-3 border border-gray-300 rounded-lg placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                       placeholder="Category (optional)">
            </div>
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                <button type="submit" id="submitLinkBtn"
                        class="group relative flex-1 flex justify-center py-3 px-4 border border-transparent text-base font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 active:scale-95 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out transform hover:scale-105">
                    Add Link
                </button>
                <button type="button" id="cancelEditBtn" class="hidden
                        group relative flex-1 flex justify-center py-3 px-4 border border-gray-300 text-base font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-100 active:scale-95 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out transform hover:scale-105">
                    Cancel Edit
                </button>
            </div>
        </form>

        <!-- Search, Sort & Filter Controls -->
        <div class="mt-6 space-y-4">
            <div>
                <label for="searchLinks" class="sr-only">Search Links</label>
                <input id="searchLinks" name="searchLinks" type="text"
                    class="appearance-none block w-full px-4 py-3 border border-gray-300 rounded-lg placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                    placeholder="Search links by name, description, URL, or category...">
            </div>
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                <div class="flex-1">
                    <label for="sortOrder" class="sr-only">Sort By</label>
                    <select id="sortOrder"
                            class="block w-full px-4 py-3 border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base">
                        <option value="createdAt_desc">Date Added (Newest First)</option>
                        <option value="createdAt_asc">Date Added (Oldest First)</option>
                        <option value="name_asc">Name (A-Z)</option>
                        <option value="name_desc">Name (Z-A)</option>
                        <option value="category_asc">Category (A-Z)</option>
                        <option value="category_desc">Category (Z-A)</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label for="categoryFilter" class="sr-only">Filter By Category</label>
                    <select id="categoryFilter"
                            class="block w-full px-4 py-3 border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base">
                        <option value="all">All Categories</option>
                        <!-- Categories will be dynamically populated here -->
                    </select>
                </div>
            </div>
        </div>


        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="text-center text-gray-500 hidden mt-4">
            <svg class="animate-spin h-6 w-6 mr-3 inline-block text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Loading...
        </div>

        <!-- Message Box -->
        <div id="messageBox" class="hidden p-4 rounded-lg text-base text-white text-center mt-4 opacity-0 transition-opacity duration-300" role="alert"></div>

        <!-- Links List -->
        <div class="mt-8">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0 sm:space-x-4">
                <h3 class="text-xl font-medium text-gray-900">All Shared Links</h3>
                <div class="flex space-x-3">
                    <button id="deleteSelectedBtn" disabled
                            class="bg-red-500 hover:bg-red-600 active:scale-95 text-white text-base font-medium py-2.5 px-6 rounded-lg shadow-md transition-all duration-150 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                        Delete Selected
                    </button>
                    <button id="exportLinksBtn"
                            class="bg-green-600 hover:bg-green-700 active:scale-95 text-white text-base font-medium py-2.5 px-6 rounded-lg shadow-md transition-all duration-150 ease-in-out transform hover:scale-105">
                        Export as PDF
                    </button>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-b border-gray-200 rounded-t-lg flex items-center space-x-2">
                <input type="checkbox" id="selectAllCheckbox" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                <label for="selectAllCheckbox" class="font-medium text-gray-700 text-sm">Select All</label>
            </div>
            <ul id="linksList" class="border-t border-gray-200 divide-y divide-gray-200 rounded-b-lg shadow-sm">
                <!-- Links will be dynamically added here -->
                <li class="p-6 text-gray-500 text-center text-base">No links found. Start by adding one above!</li>
            </ul>
        </div>
    </div>

    <!-- Signature -->
    <div class="fixed bottom-4 right-4 text-gray-500 text-sm font-semibold italic opacity-80 z-10">
        ~ Rithwik Tellakula
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase and app variables
        let app;
        let db;
        let auth;
        let currentUserId = null;
        let allLinks = []; // Store all fetched links for filtering
        let currentSearchQuery = '';
        let currentSortOrder = 'createdAt_desc'; // Default sort order
        let currentCategoryFilter = 'all'; // Default category filter
        let editMode = false;
        let currentEditingLink = null;
        let selectedLinkIds = new Set(); // New: Set to store IDs of selected links

        // --- IMPORTANT: PASTE YOUR FIREBASE CONFIGURATION HERE ---
        // You can get this from your Firebase project settings (Project overview -> Project settings -> General -> Your apps -> Web app)
        const firebaseConfig = {
            apiKey: "AIzaSyBYYNUhD6N9VCG5kJZevOrgt3-8v1jt3Ug", // THIS IS LINE 172. REPLACE WITH YOUR ACTUAL KEY.
            authDomain: "r-tube-bzymk.firebaseapp.com",
            projectId: "r-tube-bzymk",
            storageBucket: "r-tube-bzymk.firebasestorage.app",
            messagingSenderId: "737701224099",
            appId: "1:737701224099:web:a3b68d8f342b3b4846a916"
        };
        // --------------------------------------------------------

        // Get DOM elements
        const addLinkForm = document.getElementById('addLinkForm');
        const linkNameInput = document.getElementById('linkName');
        const linkUrlInput = document.getElementById('linkUrl');
        const linkDescriptionInput = document.getElementById('linkDescription');
        const linkCategoryInput = document.getElementById('linkCategory');
        const searchLinksInput = document.getElementById('searchLinks');
        const linksList = document.getElementById('linksList');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageBox = document.getElementById('messageBox');
        const exportLinksBtn = document.getElementById('exportLinksBtn');
        const submitLinkBtn = document.getElementById('submitLinkBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const sortOrderSelect = document.getElementById('sortOrder'); // New: Sort dropdown
        const categoryFilterSelect = document.getElementById('categoryFilter'); // New: Category filter dropdown
        const selectAllCheckbox = document.getElementById('selectAllCheckbox'); // New: Select All checkbox
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn'); // New: Delete Selected button

        // Function to show messages to the user with fade animation
        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-500', 'bg-green-500', 'bg-blue-500');

            if (type === 'success') {
                messageBox.classList.add('bg-green-500');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-500');
            } else { // info or default
                messageBox.classList.add('bg-blue-500');
            }

            // Show and fade in
            messageBox.classList.remove('hidden');
            messageBox.classList.add('opacity-100');

            setTimeout(() => {
                // Fade out and hide
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 300); // Must match transition duration
            }, 3000);
        }

        // Function to show/hide loading indicator
        function setLoading(isLoading) {
            if (isLoading) {
                loadingIndicator.classList.remove('hidden');
            } else {
                loadingIndicator.classList.add('hidden');
            }
        }

        /**
         * Initializes Firebase and sets up authentication.
         * Retries with exponential backoff if API calls fail.
         */
        async function initializeFirebaseWithRetry(retries = 5, delay = 1000) {
            try {
                setLoading(true);

                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                    throw new Error("Please replace the placeholder values in firebaseConfig with your actual Firebase project details. Specifically, ensure 'apiKey' is set correctly.");
                }

                console.log("Firebase config being used:", firebaseConfig);

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = currentUserId;
                        setupSharedLinksListener(firebaseConfig.appId);
                    } else {
                        currentUserId = null;
                        userIdDisplay.textContent = 'Not Authenticated';
                        linksList.innerHTML = '<li class="p-6 text-gray-500 text-center text-base">Please sign in to view links.</li>';
                    }
                    setLoading(false);
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                if (retries > 0) {
                    console.log(`Retrying Firebase initialization in ${delay / 1000} seconds...`);
                    await new Promise(res => setTimeout(res, delay));
                    await initializeFirebaseWithRetry(retries - 1, delay * 2);
                } else {
                    showMessage(`Failed to connect to Firebase after multiple retries. Error: ${error.message}. Please ensure your 'firebaseConfig' in the code is correct AND the 'Anonymous' sign-in method is ENABLED under 'Authentication' in your Firebase Console.`, "error");
                    userIdDisplay.textContent = 'Error';
                    setLoading(false);
                }
            }
        }

        /**
         * Copies text to clipboard.
         * Using document.execCommand('copy') for better iframe compatibility.
         * @param {string} text The text to copy.
         */
        function copyTextToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showMessage('Link copied to clipboard!', 'success');
                } else {
                    throw new Error('Fallback: Text could not be copied.');
                }
            } catch (err) {
                console.error('Failed to copy text:', err);
                showMessage('Failed to copy link. Please copy manually.', 'error');
            } finally {
                document.body.removeChild(textarea);
            }
        }

        /**
         * Renders the filtered, sorted links to the UI with animations.
         */
        function renderFilteredAndSortedLinks() {
            const currentLinksInDOM = new Map();
            linksList.querySelectorAll('li[data-id]').forEach(item => {
                currentLinksInDOM.set(item.dataset.id, item);
            });

            // Apply search filter
            const searchTerm = currentSearchQuery.toLowerCase();
            let processedLinks = allLinks.filter(link => {
                const name = link.name ? link.name.toLowerCase() : '';
                const description = link.description ? link.description.toLowerCase() : '';
                const url = link.url ? link.url.toLowerCase() : '';
                const category = link.category ? link.category.toLowerCase() : '';
                return name.includes(searchTerm) || description.includes(searchTerm) || url.includes(searchTerm) || category.includes(searchTerm);
            });

            // Apply category filter
            if (currentCategoryFilter !== 'all') {
                processedLinks = processedLinks.filter(link => 
                    (link.category ? link.category.toLowerCase() : '').includes(currentCategoryFilter.toLowerCase())
                );
            }

            // Apply sorting
            processedLinks.sort((a, b) => {
                switch (currentSortOrder) {
                    case 'name_asc':
                        return (a.name || '').localeCompare(b.name || '');
                    case 'name_desc':
                        return (b.name || '').localeCompare(a.name || '');
                    case 'createdAt_asc':
                        return (a.createdAt ? a.createdAt.toMillis() : 0) - (b.createdAt ? b.createdAt.toMillis() : 0);
                    case 'createdAt_desc':
                        return (b.createdAt ? b.createdAt.toMillis() : 0) - (a.createdAt ? a.createdAt.toMillis() : 0);
                    case 'category_asc':
                        return (a.category || '').localeCompare(b.category || '');
                    case 'category_desc':
                        return (b.category || '').localeCompare(a.category || '');
                    default:
                        return 0;
                }
            });

            // Update Delete Selected button state
            deleteSelectedBtn.disabled = selectedLinkIds.size === 0;
            selectAllCheckbox.checked = selectedLinkIds.size > 0 && selectedLinkIds.size === processedLinks.length;


            // Identify items to remove (not in new processed list or existing DOM)
            currentLinksInDOM.forEach((item, id) => {
                if (!processedLinks.some(link => link.id === id)) {
                    item.classList.add('link-item-exit-active');
                    setTimeout(() => {
                        if (linksList.contains(item)) {
                            linksList.removeChild(item);
                        }
                    }, 300);
                }
            });

            // Create or update items and add new ones
            const fragment = document.createDocumentFragment();
            let animationDelay = 0;

            if (processedLinks.length === 0) {
                const noLinksMessage = document.createElement('li');
                noLinksMessage.className = 'p-6 text-gray-500 text-center text-base';
                noLinksMessage.textContent = 'No matching links found. Try adding some, or adjusting your search.';
                fragment.appendChild(noLinksMessage);
            } else {
                processedLinks.forEach(link => {
                    let listItem = currentLinksInDOM.get(link.id);

                    if (!listItem) {
                        listItem = document.createElement('li');
                        listItem.className = 'flex flex-col sm:flex-row items-start sm:items-center justify-between py-4 px-6 transition-colors duration-200 group space-y-2 sm:space-y-0 link-item-enter';
                        listItem.dataset.id = link.id;

                        void listItem.offsetWidth;
                        setTimeout(() => {
                            listItem.classList.remove('link-item-enter');
                            listItem.classList.add('link-item-enter-active');
                        }, animationDelay);
                        animationDelay += 50;
                    } else {
                        listItem.classList.remove('link-item-exit-active');
                    }

                    // Check if link is selected
                    const isChecked = selectedLinkIds.has(link.id);

                    listItem.innerHTML = `
                        <div class="flex items-center">
                            <input type="checkbox" data-id="${link.id}" class="link-checkbox h-5 w-5 text-blue-600 rounded mr-3" ${isChecked ? 'checked' : ''}>
                            <div class="flex-grow flex flex-col w-full sm:w-auto">
                                <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-medium text-lg break-words">
                                    ${link.name}
                                </a>
                                ${link.description ? `<p class="text-gray-600 text-sm mt-1 hidden group-hover:block break-words">${link.description}</p>` : ''}
                                ${link.category ? `<p class="text-gray-600 text-xs mt-1">Category: <span class="font-medium">${link.category}</span></p>` : ''}
                                <div class="flex items-center space-x-2 mt-1">
                                    <p class="text-gray-500 text-sm truncate max-w-[calc(100%-30px)]">${link.url}</p>
                                    <button data-url="${link.url}" class="copy-btn text-gray-400 hover:text-blue-600 focus:outline-none focus:ring-1 focus:ring-blue-500 rounded-full p-1 transition-colors duration-150 active:scale-95" title="Copy Link">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                                        </svg>
                                    </button>
                                </div>
                                <p class="text-gray-400 text-xs mt-1">Added: ${link.createdAt && typeof link.createdAt.toDate === 'function' ? link.createdAt.toDate().toLocaleDateString() : 'N/A'}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2 mt-2 sm:mt-0">
                            <button data-id="${link.id}"
                                    data-name="${link.name}"
                                    data-url="${link.url}"
                                    data-description="${link.description || ''}"
                                    data-category="${link.category || ''}"
                                    class="edit-btn bg-blue-500 hover:bg-blue-600 active:scale-95 text-white font-bold py-2 px-4 rounded-full shadow-md text-sm transition-all duration-200 ease-in-out transform hover:scale-105">
                                Edit
                            </button>
                            <button data-id="${link.id}" class="delete-btn bg-red-500 hover:bg-red-600 active:scale-95 text-white font-bold py-2 px-4 rounded-full shadow-md text-sm transition-all duration-200 ease-in-out transform hover:scale-105">
                                Delete
                            </button>
                        </div>
                    `;
                    fragment.appendChild(listItem);
                });
            }

            linksList.innerHTML = '';
            linksList.appendChild(fragment);

            // Re-attach listeners for all buttons and checkboxes
            linksList.querySelectorAll('.copy-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const urlToCopy = event.currentTarget.dataset.url;
                    copyTextToClipboard(urlToCopy);
                });
            });

            linksList.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const linkId = event.currentTarget.dataset.id;
                    const linkName = event.currentTarget.dataset.name;
                    const linkUrl = event.currentTarget.dataset.url;
                    const linkDescription = event.currentTarget.dataset.description;
                    const linkCategory = event.currentTarget.dataset.category;
                    
                    enterEditMode({
                        id: linkId,
                        name: linkName,
                        url: linkUrl,
                        description: linkDescription,
                        category: linkCategory
                    });
                });
            });

            // Attach listeners for newly rendered checkboxes
            linksList.querySelectorAll('.link-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', toggleLinkSelection);
            });
        }


        /**
         * Populates the category filter dropdown with unique categories from allLinks.
         */
        function populateCategoryFilter() {
            const categories = new Set();
            allLinks.forEach(link => {
                if (link.category && link.category.trim() !== '') {
                    categories.add(link.category.trim());
                }
            });

            // Clear existing options, but keep "All Categories"
            categoryFilterSelect.innerHTML = '<option value="all">All Categories</option>';
            Array.from(categories).sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilterSelect.appendChild(option);
            });

            // Ensure the currently selected filter is still set
            categoryFilterSelect.value = currentCategoryFilter;
        }

        /**
         * Enters edit mode, populating the form with selected link data.
         * @param {object} link - The link object to edit.
         */
        function enterEditMode(link) {
            editMode = true;
            currentEditingLink = link;

            linkNameInput.value = link.name;
            linkUrlInput.value = link.url;
            linkDescriptionInput.value = link.description;
            linkCategoryInput.value = link.category;

            submitLinkBtn.textContent = 'Save Changes';
            submitLinkBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            submitLinkBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
            cancelEditBtn.classList.remove('hidden');

            window.scrollTo({
                top: addLinkForm.offsetTop - 20,
                behavior: 'smooth'
            });

            showMessage(`Editing "${link.name}"`, 'info');
        }

        /**
         * Resets the form and exits edit mode.
         */
        function exitEditMode() {
            editMode = false;
            currentEditingLink = null;

            linkNameInput.value = '';
            linkUrlInput.value = '';
            linkDescriptionInput.value = '';
            linkCategoryInput.value = '';

            submitLinkBtn.textContent = 'Add Link';
            submitLinkBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
            submitLinkBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            cancelEditBtn.classList.add('hidden');
            showMessage('Ready to add new links.');
        }

        /**
         * Sets up a real-time listener for links from the SHARED Firestore collection.
         * @param {string} appId - The ID of the current application.
         */
        function setupSharedLinksListener(appId) {
            if (!db) {
                console.warn("Firestore not available for listener.");
                return;
            }

            const sharedLinksCollectionRef = collection(db, `artifacts/${appId}/public/data/links`);
            const q = query(sharedLinksCollectionRef);

            console.log(`Setting up listener for SHARED path: artifacts/${appId}/public/data/links`);

            onSnapshot(q, (snapshot) => {
                allLinks = [];
                snapshot.forEach((doc) => {
                    allLinks.push({ id: doc.id, ...doc.data() });
                });
                populateCategoryFilter(); // Update category filter options
                renderFilteredAndSortedLinks(); // Re-render links after data changes
            }, (error) => {
                console.error("Error listening to shared links:", error);
                showMessage("Error fetching shared links. Please check your Firestore Security Rules for public access.", "error");
            });
        }

        /**
         * Adds a new link or updates an existing one based on editMode.
         * @param {Event} event - The form submission event.
         */
        async function handleLinkSubmit(event) {
            event.preventDefault();
            if (!db) {
                showMessage("Database not initialized. Please wait or check console for errors.", "error");
                return;
            }

            const name = linkNameInput.value.trim();
            const url = linkUrlInput.value.trim();
            const description = linkDescriptionInput.value.trim();
            const category = linkCategoryInput.value.trim();

            if (!name || !url) {
                showMessage("Please enter both link name and URL.", "error");
                return;
            }

            setLoading(true);
            try {
                const appIdForOperation = firebaseConfig.appId;

                if (!appIdForOperation || appIdForOperation === 'YOUR_APP_ID') {
                    throw new Error("Application ID is not correctly configured for Firestore operations.");
                }

                const sharedLinksCollectionRef = collection(db, `artifacts/${appIdForOperation}/public/data/links`);

                if (editMode && currentEditingLink) {
                    const linkDocRef = doc(db, sharedLinksCollectionRef.path, currentEditingLink.id);
                    await updateDoc(linkDocRef, {
                        name: name,
                        url: url,
                        description: description,
                        category: category
                    });
                    showMessage("Link updated successfully!", "success");
                } else {
                    await addDoc(sharedLinksCollectionRef, {
                        name: name,
                        url: url,
                        description: description,
                        category: category,
                        createdAt: new Date(),
                        addedBy: currentUserId
                    });
                    showMessage("Link added successfully to shared list!", "success");
                }
                exitEditMode();
            }
            catch (e) {
                console.error("Error saving document: ", e);
                showMessage(`Error saving link: ${e.message}`, "error");
            } finally {
                setLoading(false);
            }
        }

        /**
         * Deletes a link from the SHARED Firestore collection.
         * @param {string} linkId - The ID of the link to delete.
         */
        async function deleteLink(linkId) {
            if (!db) {
                showMessage("Database not initialized. Cannot delete.", "error");
                return;
            }

            const confirmDelete = await new Promise(resolve => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm mx-auto">
                        <p class="text-lg font-semibold text-gray-800 mb-4">Are you sure you want to delete this link?</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirmYes" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md">Yes</button>
                            <button id="confirmNo" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md">No</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('confirmYes').onclick = () => {
                    document.body.removeChild(modal);
                    resolve(true);
                };
                document.getElementById('confirmNo').onclick = () => {
                    document.body.removeChild(modal);
                    resolve(false);
                };
            });

            if (!confirmDelete) {
                return;
            }

            setLoading(true);
            try {
                const appIdForOperation = firebaseConfig.appId;

                if (!appIdForOperation || appIdForOperation === 'YOUR_APP_ID') {
                    throw new Error("Application ID is not correctly configured for Firestore operations.");
                }

                const linkDocRef = doc(db, `artifacts/${appIdForOperation}/public/data/links`, linkId);
                await deleteDoc(linkDocRef);
                showMessage("Link deleted successfully from shared list!", "success");
                selectedLinkIds.delete(linkId); // Remove from selected set
            } catch (e) {
                console.error("Error removing document from shared collection: ", e);
                showMessage("Error deleting link. Please try again. " + e.message, "error");
            } finally {
                setLoading(false);
            }
        }

        /**
         * Toggles the selection of a single link.
         * @param {Event} event - The change event from the checkbox.
         */
        function toggleLinkSelection(event) {
            const linkId = event.target.dataset.id;
            if (event.target.checked) {
                selectedLinkIds.add(linkId);
            } else {
                selectedLinkIds.delete(linkId);
            }
            deleteSelectedBtn.disabled = selectedLinkIds.size === 0;
            // Update selectAll checkbox state
            selectAllCheckbox.checked = selectedLinkIds.size > 0 && selectedLinkIds.size === linksList.querySelectorAll('li[data-id]').length;
        }

        /**
         * Toggles all visible links selected or unselected.
         */
        function toggleSelectAll() {
            const allVisibleCheckboxes = linksList.querySelectorAll('.link-checkbox');
            const shouldSelectAll = selectAllCheckbox.checked;

            allVisibleCheckboxes.forEach(checkbox => {
                checkbox.checked = shouldSelectAll;
                const linkId = checkbox.dataset.id;
                if (shouldSelectAll) {
                    selectedLinkIds.add(linkId);
                } else {
                    selectedLinkIds.delete(linkId);
                }
            });
            deleteSelectedBtn.disabled = selectedLinkIds.size === 0;
        }

        /**
         * Deletes all currently selected links.
         */
        async function deleteSelectedLinks() {
            if (selectedLinkIds.size === 0) {
                showMessage("No links selected for deletion.", "info");
                return;
            }

            const confirmDelete = await new Promise(resolve => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm mx-auto">
                        <p class="text-lg font-semibold text-gray-800 mb-4">Are you sure you want to delete ${selectedLinkIds.size} selected links?</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirmYes" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md">Yes</button>
                            <button id="confirmNo" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md">No</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('confirmYes').onclick = () => {
                    document.body.removeChild(modal);
                    resolve(true);
                };
                document.getElementById('confirmNo').onclick = () => {
                    document.body.removeChild(modal);
                    resolve(false);
                };
            });

            if (!confirmDelete) {
                return;
            }

            setLoading(true);
            let deletedCount = 0;
            const linkIdsToDelete = Array.from(selectedLinkIds); // Create a copy as set will change

            for (const linkId of linkIdsToDelete) {
                try {
                    const appIdForOperation = firebaseConfig.appId;
                    const linkDocRef = doc(db, `artifacts/${appIdForOperation}/public/data/links`, linkId);
                    await deleteDoc(linkDocRef);
                    deletedCount++;
                    selectedLinkIds.delete(linkId); // Remove from set immediately after successful deletion
                } catch (e) {
                    console.error(`Error deleting link ${linkId}:`, e);
                    // Continue trying to delete others even if one fails
                }
            }

            if (deletedCount > 0) {
                showMessage(`Successfully deleted ${deletedCount} link(s)!`, "success");
            } else {
                showMessage("No links were deleted or an error occurred.", "error");
            }
            selectAllCheckbox.checked = false; // Deselect all after operation
            deleteSelectedBtn.disabled = true; // Disable button
            setLoading(false);
        }


        /**
         * Exports all current links to a PDF file in table format.
         */
        async function exportLinksToPdf() {
            if (allLinks.length === 0) {
                showMessage("No links to export!", "info");
                return;
            }

            setLoading(true);
            showMessage("Generating PDF...", "info");

            const pdfContainer = document.createElement('div');
            pdfContainer.className = 'pdf-table-container';
            document.body.appendChild(pdfContainer);

            let tableHtml = `<h2 style="text-align: center; margin-bottom: 20px; font-size: 24px; font-weight: bold; color: #1a202c;">Shared Links Report</h2>`;
            tableHtml += `<table class="pdf-table">`;
            tableHtml += `<thead><tr><th>Name</th><th>URL</th><th>Description</th><th>Category</th></tr></thead>`;
            tableHtml += `<tbody>`;

            allLinks.forEach(link => {
                tableHtml += `
                    <tr>
                        <td>
                            <a href="${link.url}" target="_blank" rel="noopener noreferrer">${link.name}</a>
                        </td>
                        <td>${link.url}</td>
                        <td>${link.description || 'No description'}</td>
                        <td>${link.category || 'N/A'}</td>
                    </tr>
                `;
            });

            tableHtml += `</tbody></table>`;
            tableHtml += `<div class="pdf-signature">~ Rithwik Tellakula</div>`;
            pdfContainer.innerHTML = tableHtml;

            try {
                const containerWidth = pdfContainer.scrollWidth;
                const containerHeight = pdfContainer.scrollHeight;

                const canvas = await html2canvas(pdfContainer, {
                    scale: 2,
                    useCORS: true,
                    width: containerWidth,
                    height: containerHeight
                });

                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;

                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const margin = 10;

                const imgAspectRatio = canvas.width / canvas.height;
                let imgPdfWidth = pdfWidth - (2 * margin);
                let imgPdfHeight = imgPdfWidth / imgAspectRatio;

                let heightLeft = imgPdfHeight;
                let position = margin;

                pdf.addImage(imgData, 'PNG', margin, position, imgPdfWidth, imgPdfHeight);
                heightLeft -= (pdfHeight - (2 * margin));

                let pageNum = 1;
                while (heightLeft > -10) {
                    position = -(imgPdfHeight - (pdfHeight * pageNum)) + margin;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', margin, position, imgPdfWidth, imgPdfHeight);
                    heightLeft -= (pdfHeight - (2 * margin));
                    pageNum++;
                }

                pdf.save(`shared_links_report_${new Date().toISOString().slice(0, 10)}.pdf`);
                showMessage("Links exported successfully to PDF!", "success");

            } catch (error) {
                console.error("Error exporting to PDF:", error);
                showMessage("Error exporting links to PDF. " + error.message, "error");
            } finally {
                if (document.body.contains(pdfContainer)) {
                    document.body.removeChild(pdfContainer);
                }
                setLoading(false);
            }
        }

        // Event Listeners
        window.onload = initializeFirebaseWithRetry;
        addLinkForm.addEventListener('submit', handleLinkSubmit);
        cancelEditBtn.addEventListener('click', exitEditMode);

        // Listen for clicks on the linksList for delete/edit buttons and individual checkboxes
        linksList.addEventListener('click', (event) => {
            const deleteButton = event.target.closest('.delete-btn');
            const editButton = event.target.closest('.edit-btn');
            // The checkbox listener is attached directly to each checkbox when rendered

            if (deleteButton) {
                const linkId = deleteButton.dataset.id;
                deleteLink(linkId);
            } else if (editButton) {
                const linkId = editButton.dataset.id;
                const linkName = editButton.dataset.name;
                const linkUrl = editButton.dataset.url;
                const linkDescription = editButton.dataset.description;
                const linkCategory = editButton.dataset.category;
                enterEditMode({
                    id: linkId,
                    name: linkName,
                    url: linkUrl,
                    description: linkDescription,
                    category: linkCategory
                });
            }
        });

        searchLinksInput.addEventListener('input', (event) => {
            currentSearchQuery = event.target.value;
            renderFilteredAndSortedLinks();
        });

        sortOrderSelect.addEventListener('change', (event) => {
            currentSortOrder = event.target.value;
            renderFilteredAndSortedLinks();
        });

        categoryFilterSelect.addEventListener('change', (event) => {
            currentCategoryFilter = event.target.value;
            renderFilteredAndSortedLinks();
        });

        selectAllCheckbox.addEventListener('change', toggleSelectAll);
        deleteSelectedBtn.addEventListener('click', deleteSelectedLinks);
        exportLinksBtn.addEventListener('click', exportLinksToPdf);

    </script>
</body>
</html>
